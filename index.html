<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subscription Tracker</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <!-- Google Fonts: Manrope -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&display=swap" rel="stylesheet">
    <!-- Google Material Symbols -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
    
    <!-- Custom Tailwind Config -->
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#1173d4",
              "background-light": "#f6f7f8",
              "background-dark": "#101922",
              "card-light": "#ffffff",
              "card-dark": "#1b2733",
            },
            fontFamily: {
              display: ["Manrope", "sans-serif"],
            },
            borderRadius: {
              DEFAULT: "0.25rem",
              lg: "0.5rem",
              xl: "0.75rem",
              full: "9999px",
            },
          },
        },
      };
    </script>
    
    <style>
      /* Style for Material Symbols */
      .material-symbols-outlined {
        font-variation-settings: "FILL" 0, "wght" 400, "GRAD" 0, "opsz" 24;
      }
      .material-symbols-outlined.filled {
        font-variation-settings: "FILL" 1;
      }
      /* Hide scrollbar for cleaner look */
      body {
        -ms-overflow-style: none; /* IE and Edge */
        scrollbar-width: none; /* Firefox */
      }
      body::-webkit-scrollbar {
        display: none; /* Chrome, Safari and Opera */
      }
      /* Page transition */
      .page {
        display: none;
        animation: fadeIn 0.3s ease-in-out;
      }
      .page.active {
        display: block;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-gray-800 dark:text-gray-200 antialiased">
    <div id="app-container" class="relative mx-auto flex min-h-screen w-full max-w-2xl flex-col md:flex-row">
        <!-- Sidebar Navigation for Desktop -->
        <aside class="hidden md:flex md:w-24 flex-col items-center justify-center space-y-8 border-r border-gray-200 dark:border-gray-800 bg-card-light dark:bg-card-dark">
            <a href="#" class="nav-link flex flex-col items-center gap-1 text-primary" data-page="dashboard">
                <span class="material-symbols-outlined filled">dashboard</span>
                <p class="text-xs font-medium">Dashboard</p>
            </a>
            <a href="#" class="nav-link flex flex-col items-center gap-1 text-gray-500 dark:text-gray-400" data-page="add-new">
                <span class="material-symbols-outlined">add_box</span>
                <p class="text-xs font-medium">Add New</p>
            </a>
            <a href="#" class="nav-link flex flex-col items-center gap-1 text-gray-500 dark:text-gray-400" data-page="settings">
                <span class="material-symbols-outlined">settings</span>
                <p class="text-xs font-medium">Settings</p>
            </a>
        </aside>

        <!-- Main Content Area -->
        <div class="flex-grow pb-24 md:pb-0">
            <!-- ===== DASHBOARD PAGE ===== -->
            <div id="dashboard-page" class="page active">
                <header class="sticky top-0 z-10 flex items-center justify-between bg-background-light/80 p-4 pb-2 backdrop-blur-sm dark:bg-background-dark/80">
                    <div class="w-12"></div>
                    <h1 class="flex-1 text-center text-lg font-bold text-gray-900 dark:text-white">Subscriptions</h1>
                    <div class="flex w-12 items-center justify-end">
                        <button id="add-new-header-btn" class="flex h-10 w-10 cursor-pointer items-center justify-center rounded-full text-gray-900 dark:text-white hover:bg-gray-200 dark:hover:bg-gray-700">
                            <span class="material-symbols-outlined text-3xl">add</span>
                        </button>
                    </div>
                </header>
                <main class="p-4">
                    <div id="auth-prompt" class="hidden text-center p-6 bg-primary/10 dark:bg-primary/20 rounded-xl mb-6">
                        <p>Welcome! Please sign in to manage your subscriptions.</p>
                    </div>

                    <div id="dashboard-content" class="hidden">
                        <section class="mb-8">
                            <h2 class="text-xl font-bold text-gray-900 dark:text-white">Overview</h2>
                            <div class="mt-4 grid grid-cols-2 gap-4">
                                <div class="rounded-xl bg-primary/10 p-4 dark:bg-primary/20">
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-300">Monthly Total</p>
                                    <p id="monthly-total" class="mt-1 text-2xl font-bold text-gray-900 dark:text-white">$0.00</p>
                                </div>
                                <div class="rounded-xl bg-primary/10 p-4 dark:bg-primary/20">
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-300">Yearly Total</p>
                                    <p id="yearly-total" class="mt-1 text-2xl font-bold text-gray-900 dark:text-white">$0.00</p>
                                </div>
                            </div>
                        </section>
                        <section>
                            <h2 class="text-xl font-bold text-gray-900 dark:text-white">Upcoming Bills</h2>
                            <div id="upcoming-bills-list" class="mt-4 space-y-3">
                                <p id="no-subscriptions" class="text-center text-gray-500 py-4">You have no subscriptions yet.</p>
                            </div>
                        </section>
                    </div>
                </main>
            </div>

            <!-- ===== ADD NEW PAGE ===== -->
            <div id="add-new-page" class="page">
                <header class="sticky top-0 z-10 flex items-center justify-between bg-background-light/80 p-4 pb-2 backdrop-blur-sm dark:bg-background-dark/80">
                    <div class="w-12">
                        <button class="nav-link flex h-10 w-10 cursor-pointer items-center justify-center rounded-full text-gray-900 dark:text-white hover:bg-gray-200 dark:hover:bg-gray-700" data-page="dashboard">
                          <span class="material-symbols-outlined">arrow_back</span>
                        </button>
                    </div>
                    <h1 class="flex-1 text-center text-lg font-bold text-gray-900 dark:text-white">Add Subscription</h1>
                    <div class="w-12"></div>
                </header>
                <main class="p-4">
                    <form id="subscription-form" class="space-y-4">
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Service Name</label>
                            <input type="text" id="name" name="name" required placeholder="e.g., Netflix, Spotify" class="mt-1 block w-full rounded-lg border-gray-300 bg-card-light shadow-sm focus:border-primary focus:ring-primary dark:border-gray-600 dark:bg-card-dark">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                             <div>
                                <label for="price" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Price</label>
                                <input type="number" id="price" name="price" required min="0" step="0.01" placeholder="9.99" class="mt-1 block w-full rounded-lg border-gray-300 bg-card-light shadow-sm focus:border-primary focus:ring-primary dark:border-gray-600 dark:bg-card-dark">
                            </div>
                            <div>
                                <label for="currency" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Currency</label>
                                <select id="currency" name="currency" class="mt-1 block w-full rounded-lg border-gray-300 bg-card-light shadow-sm focus:border-primary focus:ring-primary dark:border-gray-600 dark:bg-card-dark">
                                    <option>USD</option><option>EUR</option><option>GBP</option><option>EGP</option><option>JPY</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="billing-cycle" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Billing Cycle</label>
                                <select id="billing-cycle" name="billing-cycle" class="mt-1 block w-full rounded-lg border-gray-300 bg-card-light shadow-sm focus:border-primary focus:ring-primary dark:border-gray-600 dark:bg-card-dark">
                                    <option value="monthly">Monthly</option>
                                    <option value="yearly">Yearly</option>
                                </select>
                            </div>
                             <div>
                                <label for="next-billing-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Next Billing Date</label>
                                <input type="date" id="next-billing-date" name="next-billing-date" required class="mt-1 block w-full rounded-lg border-gray-300 bg-card-light shadow-sm focus:border-primary focus:ring-primary dark:border-gray-600 dark:bg-card-dark">
                            </div>
                        </div>
                         <div>
                            <label for="category" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Category</label>
                            <select id="category" name="category" class="mt-1 block w-full rounded-lg border-gray-300 bg-card-light shadow-sm focus:border-primary focus:ring-primary dark:border-gray-600 dark:bg-card-dark">
                                <option value="entertainment">Entertainment</option>
                                <option value="music">Music</option>
                                <option value="work">Work/Productivity</option>
                                <option value="cloud">Cloud Storage</option>
                                <option value="health">Health & Fitness</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="pt-4">
                             <button type="submit" class="w-full rounded-xl bg-primary py-3 px-4 font-bold text-white shadow-sm hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:ring-offset-2 dark:focus:ring-offset-background-dark">
                                Add Subscription
                            </button>
                        </div>
                    </form>
                </main>
            </div>

            <!-- ===== SETTINGS PAGE ===== -->
            <div id="settings-page" class="page">
                <header class="sticky top-0 z-10 flex items-center justify-between bg-background-light/80 p-4 pb-2 backdrop-blur-sm dark:bg-background-dark/80">
                    <div class="w-12">
                        <button class="nav-link flex h-10 w-10 cursor-pointer items-center justify-center rounded-full text-gray-900 dark:text-white hover:bg-gray-200 dark:hover:bg-gray-700" data-page="dashboard">
                          <span class="material-symbols-outlined">arrow_back</span>
                        </button>
                    </div>
                    <h1 class="flex-1 text-center text-lg font-bold text-gray-900 dark:text-white">Settings</h1>
                    <div class="w-12"></div>
                </header>
                <main class="p-4 space-y-6">
                    <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl">
                        <h2 class="font-bold mb-2">Account</h2>
                        <div id="user-info-container" class="text-center">
                            <p id="auth-status" class="text-sm text-gray-600 dark:text-gray-400 mb-4">Connecting...</p>
                            <button id="google-login-btn" class="hidden w-full items-center justify-center gap-2 rounded-lg bg-red-500 py-2.5 px-4 font-semibold text-white shadow-sm hover:bg-red-600">
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42v20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4 12.955 4 4 12.955 4 24s8.955 20 20 20 20-8.955 20-20c0-2.659-.138-3.965-.389-5.234z"/><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4 16.318 4 9.656 8.337 6.306 14.691z"/><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.222 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"/><path fill="#1976D2" d="M43.611 20.083H42v20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.574l6.19 5.238C42.012 35.836 44 30.138 44 24c0-2.659-.138-3.965-.389-5.234z"/></svg>
                                Sign In with Google
                            </button>
                            <button id="sign-out-btn" class="hidden w-full rounded-lg bg-gray-200 py-2.5 px-4 font-semibold text-gray-800 shadow-sm hover:bg-gray-300 dark:bg-gray-600 dark:text-white dark:hover:bg-gray-500">Sign Out</button>
                        </div>
                    </div>
                    <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl">
                        <h2 class="font-bold mb-2">Appearance</h2>
                        <div class="flex justify-between items-center">
                            <span>Dark Mode</span>
                             <button id="dark-mode-toggle" class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent bg-gray-200 dark:bg-gray-600 transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 dark:focus:ring-offset-background-dark">
                                <span class="pointer-events-none relative inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out translate-x-0 dark:translate-x-5">
                                    <span class="absolute inset-0 flex h-full w-full items-center justify-center transition-opacity opacity-100 ease-in duration-200 dark:opacity-0 dark:ease-out dark:duration-100">
                                        <span class="material-symbols-outlined !text-base text-gray-400">light_mode</span>
                                    </span>
                                    <span class="absolute inset-0 flex h-full w-full items-center justify-center transition-opacity opacity-0 ease-out duration-100 dark:opacity-100 dark:ease-in dark:duration-200">
                                        <span class="material-symbols-outlined !text-base text-primary">dark_mode</span>
                                    </span>
                                </span>
                            </button>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <!-- Bottom Navigation for Mobile -->
        <footer class="sticky bottom-0 z-10 border-t border-gray-200 bg-background-light/90 pb-safe-area-inset-bottom pt-2 backdrop-blur-sm dark:border-gray-800 dark:bg-background-dark/90 md:hidden">
            <nav class="flex justify-around">
                <a class="nav-link flex flex-col items-center gap-1 text-primary" href="#" data-page="dashboard">
                    <span class="material-symbols-outlined filled">dashboard</span>
                    <p class="text-xs font-medium">Dashboard</p>
                </a>
                <a class="nav-link flex flex-col items-center gap-1 text-gray-500 dark:text-gray-400" href="#" data-page="add-new">
                    <span class="material-symbols-outlined">add_box</span>
                    <p class="text-xs font-medium">Add New</p>
                </a>
                <a class="nav-link flex flex-col items-center gap-1 text-gray-500 dark:text-gray-400" href="#" data-page="settings">
                    <span class="material-symbols-outlined">settings</span>
                    <p class="text-xs font-medium">Settings</p>
                </a>
            </nav>
        </footer>
    </div>

    <!-- Firebase -->
    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, addDoc, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "__FIREBASE_API_KEY__",
            authDomain: "__FIREBASE_AUTH_DOMAIN__",
            projectId: "__FIREBASE_PROJECT_ID__",
            storageBucket: "__FIREBASE_STORAGE_BUCKET__",
            messagingSenderId: "__FIREBASE_MESSAGING_SENDER_ID__",
            appId: "__FIREBASE_APP_ID__"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-subscription-tracker';
        
        // --- App Initialization ---
        let app, auth, db, userId;
        let subscriptions = [];
        let unsubscribe;

        // --- DOM Elements ---
        const navLinks = document.querySelectorAll('.nav-link');
        const pages = document.querySelectorAll('.page');
        const subscriptionForm = document.getElementById('subscription-form');
        const upcomingBillsList = document.getElementById('upcoming-bills-list');
        const noSubscriptionsMessage = document.getElementById('no-subscriptions');
        const monthlyTotalEl = document.getElementById('monthly-total');
        const yearlyTotalEl = document.getElementById('yearly-total');
        const authStatusEl = document.getElementById('auth-status');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const signOutBtn = document.getElementById('sign-out-btn');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const addNewHeaderBtn = document.getElementById('add-new-header-btn');
        const authPrompt = document.getElementById('auth-prompt');
        const dashboardContent = document.getElementById('dashboard-content');


        // --- Page Navigation ---
        function navigateTo(pageId) {
            pages.forEach(page => page.classList.toggle('active', page.id === `${pageId}-page`));
            
            navLinks.forEach(link => {
                const linkPage = link.dataset.page;
                const icon = link.querySelector('.material-symbols-outlined');
                if (linkPage === pageId) {
                    link.classList.remove('text-gray-500', 'dark:text-gray-400');
                    link.classList.add('text-primary');
                    icon.classList.add('filled');
                } else {
                    link.classList.add('text-gray-500', 'dark:text-gray-400');
                    link.classList.remove('text-primary');
                    icon.classList.remove('filled');
                }
            });
        }

        // --- Category to Icon Mapping ---
        const categoryDetails = {
            entertainment: { icon: 'movie', color: 'red' },
            music: { icon: 'music_note', color: 'yellow' },
            work: { icon: 'work', color: 'blue' },
            cloud: { icon: 'cloud', color: 'green' },
            health: { icon: 'fitness_center', color: 'purple' },
            other: { icon: 'label', color: 'gray' },
        };
        
        // --- Main App Logic ---
        async function initialize() {
            setLogLevel('debug');
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    authStatusEl.textContent = `Signed in as: ${user.email}`;
                    googleLoginBtn.classList.add('hidden');
                    signOutBtn.classList.remove('hidden');
                    authPrompt.classList.add('hidden');
                    dashboardContent.classList.remove('hidden');
                    await attachFirestoreListener();
                } else {
                    userId = null;
                    authStatusEl.textContent = "You are not signed in.";
                    googleLoginBtn.classList.remove('hidden');
                    signOutBtn.classList.add('hidden');
                    authPrompt.classList.remove('hidden');
                    dashboardContent.classList.add('hidden');

                    if (unsubscribe) unsubscribe();
                    subscriptions = [];
                    renderDashboard(); 
                }
            });
        }
        
        async function attachFirestoreListener() {
            if (!userId) return;
            const collectionPath = `/artifacts/${appId}/users/${userId}/subscriptions`;
            const subscriptionsCollection = collection(db, collectionPath);
            if (unsubscribe) unsubscribe();
            
            unsubscribe = onSnapshot(subscriptionsCollection, (snapshot) => {
                subscriptions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderDashboard();
            }, (error) => console.error("Firestore Snapshot Error: ", error));
        }
        
        // --- Rendering Functions ---
        function renderDashboard() {
            renderUpcomingBills();
            calculateTotals();
        }

        function renderUpcomingBills() {
            upcomingBillsList.innerHTML = ''; 
            
            if (subscriptions.length === 0) {
                noSubscriptionsMessage.style.display = 'block';
                return;
            } 
            
            noSubscriptionsMessage.style.display = 'none';
            subscriptions.sort((a, b) => calculateDaysLeft(a.nextBillingDate) - calculateDaysLeft(b.nextBillingDate));
            
            subscriptions.forEach(sub => {
                const billElement = createUpcomingBillElement(sub);
                upcomingBillsList.appendChild(billElement);
            });
        }

        function createUpcomingBillElement(sub) {
            const div = document.createElement('div');
            
            const daysLeft = calculateDaysLeft(sub.nextBillingDate);
            const details = categoryDetails[sub.category] || categoryDetails.other;

            let ringColor, textColor, dueDateText;
            if (daysLeft < 0) {
                ringColor = 'ring-gray-500/50';
                textColor = 'text-gray-500';
                dueDateText = `Billed ${Math.abs(daysLeft)} days ago`;
            } else if (daysLeft < 7) {
                ringColor = 'ring-red-500/50';
                textColor = 'text-red-500';
                dueDateText = `Due in ${daysLeft} days`;
            } else if (daysLeft < 15) {
                ringColor = 'ring-yellow-500/50';
                textColor = 'text-yellow-500';
                dueDateText = `Due in ${daysLeft} days`;
            } else {
                ringColor = 'ring-green-500/50';
                textColor = 'text-green-500';
                dueDateText = `Due in ${daysLeft} days`;
            }
            if (daysLeft === 0) dueDateText = 'Due today';
            if (daysLeft === 1) dueDateText = 'Due tomorrow';
            
            const iconBgColor = `bg-${details.color}-500/10`;
            const iconTextColor = `text-${details.color}-500`;

            div.className = `flex items-center gap-4 rounded-xl p-3 ring-2 ${ringColor} bg-card-light dark:bg-card-dark`;
            div.innerHTML = `
                <div class="flex size-12 shrink-0 items-center justify-center rounded-lg ${iconBgColor}">
                    <span class="material-symbols-outlined ${iconTextColor}">${details.icon}</span>
                </div>
                <div class="flex-grow">
                    <p class="font-semibold text-gray-800 dark:text-gray-100">${sub.name}</p>
                    <p class="text-sm ${textColor}">${dueDateText}</p>
                </div>
                <div class="shrink-0 text-right">
                    <p class="text-base font-bold text-gray-800 dark:text-gray-100">${formatCurrency(sub.price, sub.currency)}</p>
                    <button class="delete-btn text-xs text-gray-400 hover:text-red-500" data-id="${sub.id}">Delete</button>
                </div>
            `;
            
            div.querySelector('.delete-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                if (confirm('Are you sure you want to delete this subscription?')) {
                    deleteSubscription(e.target.dataset.id);
                }
            });

            return div;
        }

        function calculateTotals() {
            let monthlyTotal = 0;
            let yearlyTotal = 0;
            const displayCurrency = subscriptions.length > 0 ? subscriptions[0].currency : 'USD';

            subscriptions.forEach(sub => {
                if (sub.billingCycle === 'monthly') {
                    monthlyTotal += sub.price;
                    yearlyTotal += sub.price * 12;
                } else if (sub.billingCycle === 'yearly') {
                    yearlyTotal += sub.price;
                    monthlyTotal += sub.price / 12;
                }
            });

            monthlyTotalEl.textContent = formatCurrency(monthlyTotal, displayCurrency);
            yearlyTotalEl.textContent = formatCurrency(yearlyTotal, displayCurrency);
        }

        // --- Form & Data Handling ---
        async function handleAddSubscription(event) {
            event.preventDefault();
            if (!userId) { return; }

            const formData = new FormData(subscriptionForm);
            const newSub = {
                name: formData.get('name'),
                price: parseFloat(formData.get('price')),
                currency: formData.get('currency'),
                billingCycle: formData.get('billing-cycle'),
                nextBillingDate: formData.get('next-billing-date'),
                category: formData.get('category'),
            };

            try {
                const collectionPath = `/artifacts/${appId}/users/${userId}/subscriptions`;
                await addDoc(collection(db, collectionPath), newSub);
                subscriptionForm.reset();
                setDefaultDate();
                navigateTo('dashboard');
            } catch (error) {
                console.error("Error adding subscription: ", error);
            }
        }

        async function deleteSubscription(id) {
             if (!userId) { return; }
            try {
                const docPath = `/artifacts/${appId}/users/${userId}/subscriptions/${id}`;
                await deleteDoc(doc(db, docPath));
            } catch (error) {
                console.error("Error deleting subscription: ", error);
            }
        }
        
        // --- Authentication ---
        async function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google Sign-in Error:", error);
                authStatusEl.textContent = "Error signing in.";
            }
        }
        async function signOutUser() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Sign Out Error:", error);
            }
        }

        // --- Utility & UI Functions ---
        function calculateDaysLeft(dateString) {
            const today = new Date();
            const billingDate = new Date(dateString);
            today.setHours(0, 0, 0, 0);
            billingDate.setHours(0, 0, 0, 0);
            return Math.ceil((billingDate - today) / (1000 * 60 * 60 * 24));
        }

        function formatCurrency(amount, currency) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: currency }).format(amount);
        }

        function setDefaultDate() {
            const dateInput = document.getElementById('next-billing-date');
            if (dateInput) {
                dateInput.value = new date().toISOString().split('T')[0];
            }
        }
        
        function setupDarkMode() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                darkModeToggle.querySelector('span > span').classList.add('translate-x-5');
            } else {
                document.documentElement.classList.remove('dark');
                darkModeToggle.querySelector('span > span').classList.remove('translate-x-5');
            }
            
            darkModeToggle.addEventListener('click', () => {
                if (document.documentElement.classList.contains('dark')) {
                    document.documentElement.classList.remove('dark');
                    localStorage.theme = 'light';
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.theme = 'dark';
                }
                 darkModeToggle.querySelector('span > span').classList.toggle('translate-x-5');
            });
        }
        
        // --- Event Listeners ---
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo(link.dataset.page);
            });
        });
        
        addNewHeaderBtn.addEventListener('click', () => navigateTo('add-new'));
        subscriptionForm.addEventListener('submit', handleAddSubscription);
        googleLoginBtn.addEventListener('click', signInWithGoogle);
        signOutBtn.addEventListener('click', signOutUser);

        // --- Initial Load ---
        window.onload = () => {
            setDefaultDate();
            setupDarkMode();
            initialize();
        };

    </script>
</body>
</html>


